# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# ------------------------------------------------------------------------------
# Docker multi-platform build and push to GHCR + Docker Hub
# ------------------------------------------------------------------------------
#
# REUSEABLE INSTRUCTIONS:
#
#   1. Edit the "Configuration" env block below (same file, same spot):
#      - IMAGE_NAME          : Docker image name (e.g. myapp). Used as ghcr.io/<owner>/<IMAGE_NAME>, docker.io/<owner>/<IMAGE_NAME>.
#      - DOCKERFILE_PATH     : Path to Dockerfile (default ./Dockerfile).
#      - BUILD_CONTEXT       : Build context (default .).
#      - PLATFORMS           : Matrix in strategy (linux/amd64, linux/arm64, linux/arm/v7). Each platform builds independently (fail-fast: false).
#                              arm64 uses native runner (ubuntu-24.04-arm) for public repos; amd64 uses ubuntu-latest.
#      - VERSION_TAG_UPSTREAM_API : (Optional) On tag push, prepend a version from this GitHub API URL.
#                                  Example: https://api.github.com/repos/NationalSecurityAgency/ghidra/releases/latest
#                                  Tag format becomes (upstream_version)_(git_tag_stripped), e.g. 12.0.3_1.2.0.
#                                  Leave empty to use only the git tag as image tag (e.g. 1.2.0 → 1.2.0).
#
#   2. Tag behavior:
#      - Custom (resolve step): branch → branch name; tag → (upstream version)_(git tag) if VERSION_TAG_UPSTREAM_API set, else git tag as-is.
#      - metadata-action adds (per run): semver ({{version}}, latest), ref (branch, pr), raw "dev" on default branch; plus OCI labels (source, revision, etc.).
#
#   3. Secrets (Settings → Secrets and variables → Actions):
#      - GHCR: uses GITHUB_TOKEN (automatic) or GITHUB_PERSONAL_ACCESS_TOKEN.
#      - Docker Hub: set one of DOCKERHUB_TOKEN, DOCKER_ACCESS_TOKEN, DOCKER_HUB_TOKEN, or DOCKER_TOKEN to push to docker.io.
#      - Optional: DOCKER_USERNAME (defaults to github.repository_owner).
#
#   4. Registries: Pushes to ghcr.io/<repository_owner>/<IMAGE_NAME> and (if Docker secrets set) docker.io/<DOCKER_USERNAME>/<IMAGE_NAME>.
#      Push only runs on `push`; pull_request runs the build but does not push.
#
# ------------------------------------------------------------------------------

name: "Docker Build and Push"
run-name: ${{ github.actor }} – build and push Docker image

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  pull-requests: read

on:
  push:
    branches: ["*"]
    tags: ["*"]
  pull_request:
    branches: ["main", "master"]
  schedule:
    - cron: "17 3 * * 1"
  workflow_dispatch:

# ------------------------------------------------------------------------------
# Configuration – change these for your repo
# ------------------------------------------------------------------------------
env:
  IMAGE_NAME: bolabaden-nextjs
  DOCKERFILE_PATH: "./Dockerfile"
  BUILD_CONTEXT: "."
  # Optional: GitHub API URL for "latest" release (tag_name parsed). Empty = use only git tag on tag push.
  VERSION_TAG_UPSTREAM_API: "https://api.github.com/repos/NationalSecurityAgency/ghidra/releases/latest"

jobs:
  prepare:
    name: "Prepare"
    runs-on: ubuntu-latest
    outputs:
      IMAGE_TAG: ${{ steps.resolve.outputs.IMAGE_TAG }}
      GHIDRA_VERSION: ${{ steps.resolve.outputs.GHIDRA_VERSION }}
      SHOULD_BUILD: ${{ steps.resolve.outputs.SHOULD_BUILD }}
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: "Resolve image tag and optional upstream version"
        id: resolve
        env:
          VERSION_TAG_UPSTREAM_API: ${{ env.VERSION_TAG_UPSTREAM_API }}
          REPOSITORY_OWNER: ${{ github.repository_owner }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          SHOULD_BUILD="true"
          GHIDRA_VERSION=""
          IMAGE_TAG="${{ github.ref_name }}"

          if [[ -n "${VERSION_TAG_UPSTREAM_API}" ]]; then
            UPSTREAM_JSON=$(curl -sSL -H 'Accept: application/vnd.github+json' "${VERSION_TAG_UPSTREAM_API}")
            UPSTREAM_TAG=$(echo "$UPSTREAM_JSON" | jq -r '.tag_name // empty')
            GHIDRA_VERSION="${UPSTREAM_TAG#Ghidra_}"
            GHIDRA_VERSION="${GHIDRA_VERSION%_build}"
          fi

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            IMAGE_TAG="${{ github.ref_name }}"
          elif [[ "${EVENT_NAME}" == "schedule" || "${EVENT_NAME}" == "workflow_dispatch" ]]; then
            if [[ -n "${GHIDRA_VERSION}" ]]; then
              IMAGE_TAG="${GHIDRA_VERSION}"
              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                -H "Accept: application/vnd.oci.image.index.v1+json" \
                "https://ghcr.io/v2/${REPOSITORY_OWNER}/bolabaden-nextjs/manifests/${GHIDRA_VERSION}" || true)
              if [[ "${STATUS_CODE}" == "200" ]]; then
                SHOULD_BUILD="false"
                echo "No-op: ghcr tag ${GHIDRA_VERSION} already exists for bolabaden-nextjs."
              fi
            else
              SHOULD_BUILD="false"
              echo "No-op: upstream Ghidra version could not be resolved."
            fi
          fi

          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "GHIDRA_VERSION=${GHIDRA_VERSION}" >> $GITHUB_OUTPUT
          echo "SHOULD_BUILD=${SHOULD_BUILD}" >> $GITHUB_OUTPUT

  build-push:
    name: "Build ${{ matrix.image_key }} ${{ matrix.arch }}"
    runs-on: ${{ matrix.runner }}
    needs: prepare
    if: needs.prepare.outputs.SHOULD_BUILD == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - image_key: ghidra
            image_name: ghidra
            dockerfile: ./Dockerfile
            platform: linux/amd64
            arch: amd64
            runner: ubuntu-latest
          - image_key: ghidra
            image_name: ghidra
            dockerfile: ./Dockerfile
            platform: linux/arm64
            arch: arm64
            runner: ubuntu-24.04-arm
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: "Set env and outputs from prepare"
        id: resolve
        run: |
          echo "GHCR_IMAGE=ghcr.io/${{ github.repository_owner }}/${{ matrix.image_name }}" >> $GITHUB_ENV
          echo "DOCKERHUB_IMAGE=docker.io/${{ github.repository_owner }}/${{ matrix.image_name }}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ needs.prepare.outputs.IMAGE_TAG }}" >> $GITHUB_OUTPUT
          echo "GHIDRA_VERSION=${{ needs.prepare.outputs.GHIDRA_VERSION }}" >> $GITHUB_OUTPUT

      - name: "Set Docker token variables"
        id: set-tokens
        run: |
          echo "GITHUB_AUTH_TOKEN=${{ secrets.GITHUB_TOKEN || secrets.GITHUB_PERSONAL_ACCESS_TOKEN || '' }}" >> $GITHUB_ENV
          echo "DOCKER_TOKEN=${{ secrets.DOCKERHUB_TOKEN || secrets.DOCKER_ACCESS_TOKEN || secrets.DOCKER_HUB_TOKEN || secrets.DOCKER_TOKEN || '' }}" >> $GITHUB_ENV
          echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME || github.repository_owner }}" >> $GITHUB_ENV
          if [[ -n "${{ secrets.DOCKERHUB_TOKEN || secrets.DOCKER_ACCESS_TOKEN || secrets.DOCKER_HUB_TOKEN || secrets.DOCKER_TOKEN || '' }}" ]]; then
            echo "DOCKERHUB_AUTH=true" >> $GITHUB_ENV
          else
            echo "DOCKERHUB_AUTH=false" >> $GITHUB_ENV
          fi

      - name: "Log in to GitHub Container Registry"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ env.GITHUB_AUTH_TOKEN }}

      - name: "Log in to Docker Hub (if secrets present)"
        if: env.DOCKERHUB_AUTH == 'true'
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_TOKEN }}

      - name: "Extract Docker metadata"
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.GHCR_IMAGE }}
            ${{ env.DOCKERHUB_IMAGE }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern=latest
            type=raw,value=dev,enable=${{ github.event_name == 'push' && github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}
            type=ref,event=branch,prefix=
            type=ref,event=pr

      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "Build and push Docker image"
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.BUILD_CONTEXT }}
          file: ${{ matrix.dockerfile }}
          platforms: ${{ matrix.platform }}
          build-args: |
            GHIDRA_VERSION=${{ steps.resolve.outputs.GHIDRA_VERSION }}
          tags: |
            ${{ env.GHCR_IMAGE }}:${{ steps.resolve.outputs.IMAGE_TAG }}
            ${{ env.DOCKERHUB_IMAGE }}:${{ steps.resolve.outputs.IMAGE_TAG }}
            ${{ steps.resolve.outputs.GHIDRA_VERSION != '' && format('{0}:{1}', env.GHCR_IMAGE, steps.resolve.outputs.GHIDRA_VERSION) || '' }}
            ${{ steps.resolve.outputs.GHIDRA_VERSION != '' && format('{0}:{1}', env.DOCKERHUB_IMAGE, steps.resolve.outputs.GHIDRA_VERSION) || '' }}
            ${{ env.GHCR_IMAGE }}:latest
            ${{ env.DOCKERHUB_IMAGE }}:latest
          labels: ${{ steps.meta.outputs.labels }} # Apply OCI labels (source, revision, created, etc.) from metadata-action
          push: ${{ github.event_name != 'pull_request' }} # Push images for push/schedule/workflow_dispatch; skip on pull_request
          provenance: false # Disable SLSA provenance attestation (reduces image size)
          sbom: false # Disable software bill of materials generation (reduces metadata overhead)
          cache-from: type=gha # Load build cache from GitHub Actions cache backend for faster rebuilds
          cache-to: type=gha,mode=max # Save full layer cache to GitHub Actions for future builds (mode=max includes all layers)

      - name: "Upload image ref for manifest merge"
        if: success() && github.event_name == 'push'
        run: |
          REF="${{ env.GHCR_IMAGE }}:${{ steps.resolve.outputs.IMAGE_TAG }}@${{ steps.build.outputs.digest }}"
          mkdir -p refs
          echo "$REF" > "refs/ref-${{ matrix.image_key }}-${{ matrix.arch }}.txt"

      - name: "Upload artifact ref-${{ matrix.arch }}"
        if: success() && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: ref-${{ matrix.image_key }}-${{ matrix.arch }}
          path: refs/

  merge-manifests:
    name: "Merge manifests (${{ matrix.image_key }})"
    runs-on: ubuntu-latest
    needs: [prepare, build-push]
    if: always() && github.event_name != 'pull_request' && needs.prepare.outputs.SHOULD_BUILD == 'true' && (needs.build-push.result == 'success' || needs.build-push.result == 'failure')
    strategy:
      fail-fast: false
      matrix:
        include:
          - image_key: site
            image_name: bolabaden-nextjs
    steps:
      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "Log in to GitHub Container Registry"
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Log in to Docker Hub (if secrets present)"
        uses: docker/login-action@v3
        continue-on-error: true
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME || github.repository_owner }}
          password: ${{ secrets.DOCKERHUB_TOKEN || secrets.DOCKER_ACCESS_TOKEN || secrets.DOCKER_HUB_TOKEN || secrets.DOCKER_TOKEN }}

      - name: "Download platform refs"
        uses: actions/download-artifact@v4
        with:
          pattern: ref-${{ matrix.image_key }}-*
          path: refs-downloaded
          merge-multiple: true
        continue-on-error: true

      - name: "Create and push multi-arch manifests"
        run: |
          IMAGE_TAG="${{ needs.prepare.outputs.IMAGE_TAG }}"
          GHCR_IMAGE="ghcr.io/${{ github.repository_owner }}/${{ matrix.image_name }}"
          DOCKERHUB_IMAGE="docker.io/${{ github.repository_owner }}/${{ matrix.image_name }}"
          if [[ -z "$IMAGE_TAG" || -z "$GHCR_IMAGE" ]]; then
            echo "Missing params, skipping manifest merge"
            exit 0
          fi
          REFS=$(cat refs-downloaded/ref-*.txt 2>/dev/null || true)
          if [[ -z "$REFS" ]]; then
            echo "No platform refs found (all builds may have failed), skipping manifest merge"
            exit 0
          fi
          REFS_GHCR=$(echo "$REFS" | tr '\n' ' ')
          REFS_DOCKERHUB=$(echo "$REFS" | sed "s|${GHCR_IMAGE}|${DOCKERHUB_IMAGE}|g" | tr '\n' ' ')
          docker buildx imagetools create -t "${GHCR_IMAGE}:${IMAGE_TAG}" -t "${GHCR_IMAGE}:latest" $REFS_GHCR
          if [[ -n "$DOCKERHUB_IMAGE" ]]; then
            docker buildx imagetools create -t "${DOCKERHUB_IMAGE}:${IMAGE_TAG}" -t "${DOCKERHUB_IMAGE}:latest" $REFS_DOCKERHUB || true
          fi
